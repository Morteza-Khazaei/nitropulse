Metadata-Version: 2.4
Name: nitropulse
Version: 0.1.0
Summary: A precision tool for mapping nitrous oxide (N₂O) emission pulses in agricultural landscapes
Author-email: Morteza Khazaei <morteza.khazaei@usherbrooke.ca>
License: Apache-2.0
Keywords: AIEM,scattering,remote sensing,electromagnetics,radar
Classifier: Development Status :: 3 - Alpha
Classifier: Intended Audience :: Science/Research
Classifier: License :: OSI Approved :: Apache Software License
Classifier: Operating System :: OS Independent
Classifier: Programming Language :: Python :: 3.8
Classifier: Topic :: Scientific/Engineering :: Atmospheric Science
Requires-Python: >=3.8
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: pandas
Requires-Dist: seaborn
Requires-Dist: scipy
Requires-Dist: ipykernel
Requires-Dist: earthengine-api
Requires-Dist: geemap
Requires-Dist: RISMA
Requires-Dist: tqdm
Dynamic: license-file

# nitropulse

A precision tool for mapping nitrous oxide (N₂O) emission pulses in agricultural landscapes.

## Overview

The inversion workflow consists of the following main steps:

### 1. Data Acquisition and Preparation
- **RISMA Ground Measurements**:
  - Downloads and prepares soil moisture and temperature data from RISMA stations.
  - Stores all necessary CSV files in the `./assets/inputs/...` directory.
- **Sentinel-1 Backscatter Data**:
  - Retrieves Sentinel-1 backscatter data from Google Earth Engine (GEE).
  - Applies spatial buffering around each RISMA station to a reliable time series of backscatter data for each station.

### 2. Growing Degree Days (GDD) and Phenology Modeling
- **GDD Calculation**:
  - Calculates accumulated Growing Degree Days (GDD) from RISMA temperature data.
- **BBCH Scale**:
  - Uses GDD to compute the BBCH scale, generating a time series of crop growth stages.
  - Estimates crop height per day of year (DOY), a critical parameter for vegetation radiative transfer modeling (RTM).

### 3. Inversion Process
- **Backscatter Separation**:
  - Separates total backscatter from Sentinel-1 images into soil and vegetation components.
- **Radiative Transfer Models**:
  - Uses vegetation RTM and crop height data to accurately estimate soil and vegetation parameters.

### 4. Machine Learning and Deployment
- **Ensemble Model Training**:
  - Trains and tests ensemble models to estimate:
    - Bare soil backscatter
    - Soil roughness
    - Soil moisture
- **Google Earth Engine Deployment**:
  - Deploys trained models to the GEE platform for large-scale soil moisture estimation using Sentinel-1 backscatter images.

## Installation

### Dependencies

The package automatically installs the following dependencies:

- Python 3.8+
- Google Earth Engine Python API
- NumPy, Pandas, SciPy
- scikit-learn
- RISMA *developed during this project*
- pyAIEM *developed during this project*
- SSRT *developed during this project*

### Install from GitHub

```bash
# Install dependencies first if they are not on PyPI
# pip install git+https://github.com/Morteza-Khazaei/AIEM.git
# pip install git+https://github.com/Morteza-Khazaei/SSRT.git
pip install git+https://github.com/Morteza-Khazaei/nitropulse.git
```

### For Development

If you want to contribute or modify the package:

```bash
git clone https://github.com/Morteza-Khazaei/nitropulse.git
cd nitropulse
pip install -e .
```

### Verify Installation

After installation, verify the package is working:

```bash
python -c "import nitropulse; print('Installation successful!')"
```

## Quick Start

### 1. Install the Package

```bash
pip install git+https://github.com/Morteza-Khazaei/nitropulse.git
```

### 2. Set up Google Earth Engine

```bash
earthengine authenticate
```

### 3. Basic Usage

Run the full workflow. This will export data to your Google Drive, which you must then download manually to your workspace.

```bash
nitropulse run --roi-asset-id <your-roi-asset> --gee-project-id <your-gcp-project-id>
```

## Commands

### `nitropulse run`

Runs the complete workflow, including data download, phenology modeling, inversion, and machine learning model training.

```bash
nitropulse run [OPTIONS]
```

**Arguments:**
- `--workspace-dir`: Workspace directory for all data and outputs. Default: `~/.nitropulse`.
- `--stations`: List of station IDs to process. Default: All RISMA stations.
- `--buffer-distance`: Buffer distance for S1 data (meters). Default: `15`.
- `--start-date`: Start date for data retrieval (YYYY-MM-DD). Default: `2010-01-01`.
- `--end-date`: End date for data retrieval (YYYY-MM-DD). Default: `2024-01-01`.
- `--roi-asset-id`: **Required**. GEE asset ID for the Region of Interest.
- `--gee-project-id`: **Required**. Google Earth Engine project ID.
- `--fghz`: Frequency in GHz for inversion. Default: `5.4`.
- `--models`: RT models in JSON format. Default: `{"RT_s": "PRISM1", "RT_v": "Diff"}`.
- `--acftype`: ACF type for AIEM model. Default: `exp`.
- `--features`: Feature list for ML models. Default: `['SSM', 'vvs', 's']`.

### `nitropulse download`

Downloads RISMA and Sentinel-1 data.

```bash
nitropulse download [OPTIONS]
```

**Arguments:**
- `--workspace-dir`: Workspace directory.
- `--stations`: List of station IDs.
- `--buffer-distance`: Buffer distance for S1 data.
- `--start-date`: Start date for data.
- `--end-date`: End date for data.
- `--roi-asset-id`: **Required**. GEE asset ID for the Region of Interest.
- `--gee-project-id`: **Required**. Google Earth Engine project ID for S1 data download.

### `nitropulse phenology`

Runs the phenology model.

```bash
nitropulse phenology [OPTIONS]
```

**Arguments:**
- `--workspace-dir`: Workspace directory.

### `nitropulse inversion`

Runs the inversion algorithm.

```bash
nitropulse inversion [OPTIONS]
```

**Arguments:**
- `--workspace-dir`: Workspace directory.
- `--fghz`: Frequency in GHz.
- `--models`: RT models in JSON format.
- `--acftype`: ACF type for AIEM model.

### `nitropulse modeling`

Trains ensemble models and optionally deploys them to Google Earth Engine.

```bash
nitropulse modeling [OPTIONS]
```

**Arguments:**
- `--workspace-dir`: Workspace directory.
- `--features`: Feature list for ML models.
- `--gee-project-id`: Google Earth Engine project ID for model deployment. If not provided, models are not deployed.

## Available RISMA Stations

The package includes 13 RISMA stations in Manitoba, Canada:

- `RISMA_MB1` through `RISMA_MB13`

You can specify individual stations or use the default (all stations):

```bash
# Process specific stations
nitropulse run --stations RISMA_MB1 RISMA_MB5 --roi-asset-id <your-roi-asset> --gee-project-id <your-gcp-project-id>

# Process all stations (default)
nitropulse run --roi-asset-id <your-roi-asset> --gee-project-id <your-gcp-project-id>
```

## Workflow Steps

### 1. Data Preparation
- Downloads RISMA ground-truth data (soil moisture, temperature)
- Applies spatial buffering around station locations and retrieves Sentinel-1 backscatter data from Google Earth Engine

### 2. Phenology Modeling
- Runs BBCH phenology model to determine crop growth stages
- Outputs phenology data to `outputs/pheno_df.csv`

### 3. Inversion Process
- Applies radiative transfer models (PRISM1, Diff)
- Uses AIEM for surface scattering modeling
- Estimates soil and vegetation parameters
- Outputs inversion results to `outputs/inv_df.csv`

### 4. Machine Learning
- Trains Random Forest ensemble models
- Uses specified features for parameter estimation
- Uploads trained models to Google Earth Engine

## Output Files

The package generates several output files in the `outputs/` directory:

- `pheno_df.csv`: Phenology model results with crop growth stages
- `inv_df.csv`: Inversion results with estimated parameters
- Various intermediate data files and model artifacts

## Configuration

### Custom Models

You can specify different radiative transfer models:

```bash
nitropulse run --models '{"RT_s": "PRISM2", "RT_v": "WCM"}'
```

### Feature Selection

Customize the features used for machine learning:

```bash
nitropulse run --features SSM vvs s
```

## Google Earth Engine Setup

1. Create a Google Cloud Project
2. Enable the Earth Engine API
3. Authenticate using `earthengine authenticate`
4. Provide your project ID when running the CLI

```bash
nitropulse run --gee-project-id your-gcp-project-id
```

## Troubleshooting

### Common Issues

**Authentication Error**: Ensure you've authenticated with Google Earth Engine:
```bash
earthengine authenticate
```

**Memory Issues**: For large datasets, consider:
- Processing fewer stations at once
- Reducing the date range
- Increasing buffer distance cautiously

**Missing Data**: Check that:
- Station IDs are correct
- Date ranges overlap with available data
- GEE project has necessary permissions

### Debug Mode

For debugging, you can inspect intermediate outputs in the workspace directory structure:

```
workspace/
├── inputs/
│   ├── RISMA_CSV_SSM_SST_AirT_2015_2023_new/
│   └── S1_data/
├── outputs/
│   ├── pheno_df.csv
│   └── inv_df.csv
└── models/
```

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests for new functionality
5. Submit a pull request

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Citation

If you use this package in your research, please cite:

```bibtex
@software{nitropulse,
  title={Nitropulse: A precision tool for mapping nitrous oxide (N₂O) emission pulses in agricultural landscapes},
  author={Morteza Khazaei},
  year={2024},
  url={https://github.com/Morteza-Khazaei/nitropulse}
}
```

## Support

For support and questions:
- Create an issue on GitHub
- Contact the development team
- Check the documentation wiki

---

**Note**: This package is designed for research purposes and requires appropriate permissions for accessing Google Earth Engine and RISMA data networks.
